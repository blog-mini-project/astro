---
import { register as serverRegister } from '../lib/auth'
---

<html>
  <body>
    <h1>Sign Up</h1>
    <form id="signup-form">
      <input type="text" name="username" placeholder="Username" required />
      <input type="password" name="password" placeholder="Password" required />
      <input type="text" name="displayname" placeholder="Display Name" />
      <input type="text" name="profilepic" placeholder="Profile Picture URL" />
      <button type="submit">Sign Up</button>
    </form>
    <script>
      let error = null

      async function register(username, password, displayname, profilepic) {
        const requestBody = JSON.stringify({ username, password, displayname, profilepic })

        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: requestBody
        })
        console.log(requestBody)
        const responseText = await response.text()
        console.log('Response Text:', responseText)

        if (!response.ok) {
          const errorData = JSON.parse(responseText)
          throw new Error(errorData.message)
        }
      }

      async function handleSubmit(event) {
        event.preventDefault()
        const formData = new FormData(event.target)
        const username = formData.get('username').toString()
        const password = formData.get('password').toString()
        const displayname = formData.get('displayname')?.toString()
        const profilepic = formData.get('profilepic')?.toString()

        try {
          await register(username, password, displayname, profilepic)
          window.location.href = '/login'
        } catch (err) {
          error = err.message
          document.querySelector('body').innerHTML += `<p style="color: red">${error}</p>`
        }
      }

      document.querySelector('#signup-form').addEventListener('submit', handleSubmit)
    </script>
  </body>
</html>