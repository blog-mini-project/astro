---
import { lucia } from "../lib/auth"

const cookiename = lucia.sessionCookieName
---

<html>
  <body>
    <h1>Sign Up</h1>
    <div>
      <input type="text" id="signupUsername" name="username" placeholder="Username" required />
      <input type="password" id="signupPassword" name="password" placeholder="Password" required />
      <input type="text" id="signupDisplayName" name="displayname" placeholder="Display Name" />
      <input type="text" id="signupProfilePic" name="profilepic" placeholder="Profile Picture URL" />
      <button id="signupButton">Sign Up</button>
    </div>
    <script define:vars={{ cookiename }}>

      var cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [name, value] = cookie.split('=').map(c => c.trim())
        acc[name] = value
        return acc
      }, {})

      var checkifloggedin = cookies[cookiename] ?? null
      if (checkifloggedin) {
        window.location.href = "/home"
      }

      document.getElementById('signupButton').addEventListener('click', async (event) => {
        event.preventDefault()
        const username = document.getElementById("signupUsername").value
        const password = document.getElementById("signupPassword").value
        const displayname = document.getElementById("signupDisplayName").value
        const profilepic = document.getElementById("signupProfilePic").value

        const response = await fetch('/api/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password, displayname, profilepic })
        })

        const data = await response.json()

        if (data.success) {
            document.cookie = `${data.sessionCookie.name}=${data.sessionCookie.value}; ${data.sessionCookie.attributes}`
            window.location.href = "/home"
        } else {
            alert(data.message)
        }
      })
    </script>
  </body>
</html>