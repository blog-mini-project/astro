---
import { lucia } from "../lib/auth"

const cookiename = lucia.sessionCookieName

import Base from '../layouts/base.astro'
---
<Base title="Sign Up" classes="min-h-screen flex flex-col items-center justify-center gap-2">
    <h1 class="text-4xl p-3">Sign Up</h1>
    <div class="flex flex-col items-center justify-center gap-2">
      <input type="text" id="signupUsername" name="username" placeholder="Username" required />
      <input type="password" id="signupPassword" name="password" placeholder="Password" required />
      <input type="text" id="signupDisplayName" name="displayname" placeholder="Display Name" />
      <input type="file" id="signupProfilePic" name="profilepic" accept="image/*" />
      <button id="signupButton" class="rounded p-2">Sign Up</button>
    </div>
    <script define:vars={{ cookiename }}>

      var cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [name, value] = cookie.split('=').map(c => c.trim())
        acc[name] = value
        return acc
      }, {})

      var checkifloggedin = cookies[cookiename] ?? null
      if (checkifloggedin) {
        window.location.href = "/home"
      }

      document.getElementById('signupButton').addEventListener('click', async (event) => {
        event.preventDefault()
        const username = document.getElementById("signupUsername").value
        const password = document.getElementById("signupPassword").value
        const displayname = document.getElementById("signupDisplayName").value
        const profilepicFile = document.getElementById("signupProfilePic").files[0]

        if (!username || !password) {
          alert("Username and password are required.")
          return
        }

        let profilepic = ""
        if (profilepicFile) {
          const reader = new FileReader()
          reader.readAsDataURL(profilepicFile)
          profilepic = await new Promise((resolve) => {
            reader.onload = () => resolve(reader.result)
          })
        }

        const response = await fetch('/api/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password, displayname, profilepic })
        })

        const data = await response.json()

        if (data.success) {
            document.cookie = `${data.sessionCookie.name}=${data.sessionCookie.value}; ${data.sessionCookie.attributes}`
            window.location.href = "/home"
        } else {
            alert(data.message)
        }
      })
    </script>
<Base>