<!-- ---
export const prerender = false

import { getPost } from '../../lib/posts'
import { getComments } from '../../lib/comments'
import htmx from 'htmx'

const { postid } = Astro.params
const post = await getPost(Number(postid))
const comments = await getComments(Number(postid))

let error = null
let user = null

document.getElementById("#comment").onsubmit(event =>  {
    const formData = new FormData(event.target)
    const content = formData.get('content').toString()

    fetch(`/api/post/${postid}/comment`, {
        method: 'POST',
        body: JSON.stringify({ content, user: user.username })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            error = data.error
        } else {
            htmx.trigger(htmx.find('#comments'), 'refresh')
        }
    })
    .catch(err => {
        error = 'An error occurred while posting your comment.'
    })
})
---
<html>
  <body>
    <h1>{post.title}</h1>
    <p>{post.content}</p>
    <p>Author: <a href={`/author/${post.user}`}>{post.user}</a></p>
    <p>Published: {post.published}</p>
    <h2>Comments</h2>
    <div id="comments">
      <ul>
        {comments.map(comment => (
          <li>{comment.content} - {comment.user}</li>
        ))}
      </ul>
    </div>
    {error && <p style="color: red;">{error}</p>}
    <form id="comment">
      <textarea name="content" placeholder="Add a comment"></textarea>
      <button type="submit">Submit</button>
    </form>
  </body>
</html> -->